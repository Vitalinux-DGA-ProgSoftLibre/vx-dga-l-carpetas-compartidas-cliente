#!/bin/bash
# postinst script for vx-dga-l-carpetas-compartidas-cliente
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package


case "$1" in
    configure)

# Exportamos variables útiles
. /etc/default/vx-dga-variables/vx-dga-variables-general.conf

USUARIOLOGIN=$(who | grep " :0 " | cut -d" " -f1)
USUARIOAUTOLOGIN=$(cat /etc/lightdm/lightdm.conf | grep autologin-user= | cut -d"=" -f2)

# Damos permisos adecuados a los scripts que incluye el paquete
chmod +x /usr/bin/nfs-*.sh
chmod +x /usr/bin/vx-*nfs*

# Eliminamos posibles viejas configuraciones
for USU in $( awk -F ":" '{if ( $3 > 999 &&  $6~/\/home\/.*/) {print $1}}' /etc/passwd ) ; do
	if test -f  /home/$USU/.config/autostart/nfs-compartir.desktop ; then
		 rm -f /home/$USU/.config/autostart/nfs-compartir.desktop
	fi
done
if test -f /etc/skel/.config/autostart/nfs-compartir.desktop ; then
	chmod 000 /etc/skel/.config/autostart/nfs-compartir.desktop
fi

# Desmontamos lo que haya en ese momento en el equipo
if test -f "/usr/bin/nfs-desmontajes.sh" ; then
	/usr/bin/nfs-desmontajes.sh
fi

## Limpiamos el /etc/fstab (lo limpia el script anterior)
sed --follow-symlinks -i "/^#/d" /etc/fstab
sed --follow-symlinks -i "/^$/d" /etc/fstab
sed --follow-symlinks -i "/.*\/nfs\/alumnos.*/d" /etc/fstab
sed --follow-symlinks -i "/.*\/nfs\/profesor.*/d" /etc/fstab
sed --follow-symlinks -i "/.*\/nfs\/privado.*/d" /etc/fstab
sed --follow-symlinks -i "/.*\/nfs\/perfiles.*/d" /etc/fstab

if ! pgrep nfs-cliente &> /dev/null ; then
	echo "--> El servicio de Carpetas Compartidas no esta activo ..."
	echo "--> Se va a iniciar el Servicio de Carpetas Compartidas ..."
	/usr/bin/nfs-cliente.sh &
else
	echo "--> Ya existe un servicio de Carpetas Compartidas Activo ... "
	echo "--> La nueva versión de este servicio actuará a partir del siguiente inicio de sesión ..."
fi

# Configuramos como tarea Logout el desmontaje de las unidades de red al cierre de cada sesión
echo "--> Configuramos como tarea al cierre de sesión el desmontaje de las carpetas compartidas ..."
echo "--> Configuramos como tarea al cierre de sesión el agregar nuevos posibles puntos de montaje ..."
if test -f /usr/bin/tareas-logout ; then
	if ( test -f /usr/bin/nfs-desmontajes.sh) \
		&& ! ( grep "^/usr/bin/nfs-desmontajes.sh" /usr/bin/tareas-logout &> /dev/null ) ; then
		echo "/usr/bin/nfs-desmontajes.sh" >> /usr/bin/tareas-logout
	fi

	if ( test -f /usr/bin/nfs-agregar-montaje.sh ) \
		&& ! ( grep "^/usr/bin/nfs-agregar-montaje.sh" /usr/bin/tareas-logout &> /dev/null ) ; then
			echo "/usr/bin/nfs-agregar-montaje.sh" >> /usr/bin/tareas-logout
	fi
else
	echo "/usr/bin/nfs-desmontajes.sh" >> /usr/bin/tareas-logout
	echo "/usr/bin/nfs-agregar-montaje.sh" >> /usr/bin/tareas-logout
	chmod +x /usr/bin/tareas-logout
fi

    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
