#!/bin/bash
# postinst script for vx-dga-l-carpetas-compartidas-cliente
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package


case "$1" in
    configure)

# Exportamos variables útiles
. /etc/default/vx-dga-variables/vx-dga-variables-general.conf

USUARIOLOGIN=$(who | grep " :0 " | cut -d" " -f1)
USUARIOAUTOLOGIN=$(cat /etc/lightdm/lightdm.conf | grep autologin-user= | cut -d"=" -f2)

# Matamos el proceso encargado del montaje de las unidades de red NFS si esta activo
if ps aux | grep nfs-cliente.sh &> /dev/null ;  then
	killall nfs-cliente.sh
fi


for USU in $( awk -F ":" '{if ( $3 > 999 &&  $6~/\/home\/.*/) {print $1}}' /etc/passwd ) ; do
	if test -f  /home/$USU/.config/autostart/nfs-compartir.desktop ; then
		 rm -f /home/$USU/.config/autostart/nfs-compartir.desktop
	fi
done
if test -f /etc/skel/.config/autostart/nfs-compartir.desktop ; then
	chmod 000 /etc/skel/.config/autostart/nfs-compartir.desktop
fi

# Si no existen, creamos los directorios del montaje
# Al montar sobre /media se creará un "shortcut" en el Escritorio de los usuarios
declare -a DIRECTORIOS
DIRECTORIOS=(/media/profesores /media/alumnos /media/privado /perfiles)
for DIRECTORIO in ${DIRECTORIOS[*]} ; do
	if test ! -d $DIRECTORIO ; then
		mkdir $DIRECTORIO
	fi
done

## Limpiamos el /etc/fstab
sed --follow-symlinks -i "/^#/d" /etc/fstab
sed --follow-symlinks -i "/^$/d" /etc/fstab
sed --follow-symlinks -i "/.*\/nfs\/alumnos.*/d" /etc/fstab
sed --follow-symlinks -i "/.*\/nfs\/profesor.*/d" /etc/fstab
sed --follow-symlinks -i "/.*\/nfs\/privado.*/d" /etc/fstab
sed --follow-symlinks -i "/.*\/nfs\/perfiles.*/d" /etc/fstab

## Introducimos los puntos de montaje
if test -f /usr/share/vitalinux/nfs-compartir/unidades-nfs ; then
	RUTAMONTAJES=/usr/share/vitalinux/nfs-compartir/unidades-nfs
	for LINEA in $(cat $RUTAMONTAJES | tr -s " " "*") ; do
		RECURSO=$(echo $LINEA | tr -s "*" " ")
		RECURSOREMOTO=$(echo $RECURSO | cut -d":" -f1)
		CARPETAMONTAJE=$(echo $RECURSO | cut -d":" -f2)
		MENSAJEOK=$(echo $RECURSO | cut -d":" -f3)
		MENSAJEERROR=$(echo $RECURSO | cut -d":" -f4)
		MODOMONTAJE=$(echo $RECURSO | cut -d":" -f5)
		if ! (grep ^$IPCACHE:$RECURSOREMOTO /etc/fstab &> /dev/null) \
			&& ! (echo $RECURSOREMOTO | grep privado &> /dev/null); then
			echo "$IPCACHE:$RECURSOREMOTO $CARPETAMONTAJE nfs \
actimeo=1800,noatime,nolock,bg,nfsvers=3,tcp,rw,noauto,user,hard,intr,defaults,exec 0 0" >> /etc/fstab
		fi
		if ! (grep ^$IPCACHE:$RECURSOREMOTO /etc/fstab &> /dev/null) \
			&& (echo $RECURSOREMOTO | grep privado &> /dev/null) \
			&& (id $USUARIOAUTOLOGIN | grep adm &> /dev/null); then
			echo "$IPCACHE:$RECURSOREMOTO $CARPETAMONTAJE nfs \
actimeo=1800,noatime,nolock,bg,nfsvers=3,tcp,rw,noauto,user,hard,intr,defaults,exec 0 0" >> /etc/fstab
		fi
	done
fi

# Damos permisos adecuados al script que se ejecuará al arrancar
chmod +x /usr/bin/nfs-cliente.sh
/usr/bin/nfs-cliente.sh &
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
